# Лаборатоная работа по анализу логов

Жил-был чудный веб-интерфейс и все у него было хорошо: в него ходили пользователи, что-то там кликали, переходили по ссылкам, получали результат. Но со временем некоторые его странички стали тупить и долго грузиться. Менеджеры часто жалуются, мол "вот тут список долго грузился" или "интерфейсик тупит, поиск не работает". Но так трудно отделить те случаи, где проблемы на их стороне, а где действительно виноват веб-сервис. В логи интерфейса добавили время запроса (`$request_time` в `nginx` http://nginx.org/en/docs/http/ngx_http_log_module.html#log_format). Теперь можно распарсить логи и провести первичный анализ, выявив подозрительные URL'ы.

Есть два типа файлов, которые можно найти:
* .gz
* plain

Можем понять какой тип файла именно по расширению, других не может быть

Про логи:
* семпл лога: `nginx-access-ui.log-20170630.gz`
* лог ротируется раз в день


Основная функциональность:
1. Скрипт обрабатывает при запуске последний (со самой свежей датой в имени, не по mtime файла!) лог в `LOG_DIR` (константа, которую можем менять)
Ситуация, что логов на обработку нет возможна, это не должно являться ошибкой.
2. После анализа необходимо сформировать отчет и вывести его в консоль


Про отчет:
* count - сколько раз встречается URL, абсолютное значение
* count_perc - сколько раз встречается URL, в процентнах относительно общего числа запросов
* time_avg - средний \$request_time для данного URL'а
* time_max - максимальный \$request_time для данного URL'а
* time_med - медиана \$request_time для данного URL'а


Как получить нужные данные (url и время запроса) из строки лога файла

```python3

import re
string = '1.169.137.128 -  - [29/Jun/2017:03:50:22 +0300] "GET /api/v2/banner/16852664 HTTP/1.1" 200 19415 "-" "Slotovod" "-" "1498697422-2118016444-4708-9752769" "712e90144abee9" 0.199\n'
regex = re.compile(r'\"[A-Z]+ ([^\s]+) .* (\d+\.\d+)\n')
parsed_line = re.findall(regex, string) 
parsed_line
[('/api/v2/banner/16852664', '0.199')]
```

Если времени запроса нет, то считаем, что это ошибка


Как получить дату файла:

```pyhon3
regex = re.compile(r"nginx-access-ui\.log-(\d{8})(\.gz)?")
log_date_str = re.findall(regex, 'nginx-access-ui.log-20170630')
log_date_str
[('20170630', '')]
```


Как вывести все файлы в директории:

```python3
import os

os.listdir('./')  # тут ваш путь где показать файлы, например текущая папка
```


Для чтения файла можно использовать контекстные менеджеры:
```python3
with open('./.gitlab-ci.yml', 'r') as file:
    for line in file:
        print(line)

# Но так же можно запомнить и использовать это потом, может пригодится
opener = open('./file.txt', "r", encoding="UTF-8")
with opener:
        for line in opener:
            print(line)
```


Чтение gzip файлов:
```python3
import gzip
with gzip.open(log_path, "r") as file:
    pass
```